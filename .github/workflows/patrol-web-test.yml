name: Patrol Web Tests

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  patrol-web-test:
    name: Patrol Web Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache Flutter packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache/
            /root/.pub-cache/
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Cache Node.js dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: 'latest'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Setup Patrol CLI
        run: dart pub global activate patrol_cli

      - name: Verify Patrol installation
        run: patrol --version

      - name: Create test results directory
        run: mkdir -p test-results

      - name: Run Patrol Web Tests
        run: |
          # Set up virtual display for headless Chrome
          export DISPLAY=:99
          Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
          sleep 2
          
          # Run Patrol tests with comprehensive logging
          patrol test \
            --device chrome \
            --target patrol_test/app_test.dart \
            --verbose \
            --show-flutter-logs \
            --no-hide-test-steps \
            --web-video=retain-on-failure \
            --web-workers=1 \
            --web-headless=false \
            2>&1 | tee test-results/patrol-test-output.log
        shell: bash

      - name: Collect test artifacts
        run: |
          # Find and copy all test artifacts
          find . -name "*.webm" -o -name "*.html" -o -name "*.json" | while read file; do
            cp "$file" test-results/ 2>/dev/null || true
          done
          
          # Copy any additional Patrol output directories
          if [ -d "build" ]; then
            cp -r build test-results/ 2>/dev/null || true
          fi
          
          # List all collected artifacts
          echo "=== Collected Test Artifacts ==="
          find test-results -type f | sort

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: patrol-test-results
          path: test-results/
          retention-days: 7

      - name: Upload test videos (if any)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: patrol-test-videos
          path: |
            test-results/*.webm
            test-results/**/*.webm
          retention-days: 7

      - name: Display test summary
        if: always()
        run: |
          echo "=== Patrol Test Summary ==="
          if [ -f "test-results/patrol-test-output.log" ]; then
            echo "Test output log size: $(wc -l < test-results/patrol-test-output.log) lines"
            echo "Last 50 lines of test output:"
            tail -50 test-results/patrol-test-output.log
          fi
          
          echo "=== Available Artifacts ==="
          find test-results -type f -exec ls -lh {} \; | sort